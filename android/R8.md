[TOC]

# R8

- 안드로이드 스튜디오 3.4, AGP 3.4.0이상을 이용한다면 R8 컴파일러를 이용하여  미사용 코드, 리소스를 제거, 코드 난독화를 통해 앱의 크기를 줄일 수 있다.
- 여러 과정을 통해서 빌드시간이 좀 더 오리걸릴 수 있고, 개발자가 프로젝트에 맞게 적절한 처리가 없다면 앱이 정상 작동하지 않을 수 있다.

## Code shrinking (코드 축소)

- 앱 모듈, 라이브러리에서 사용하지 않는 코드를 찾아 안전하게 제거한다.
- R8 컴파일러는 코드에 있는 모든 엔트리 포인트를 찾아 진입점을 찾는다.
- 이러한 엔트리 포인트는 안드로이드 플랫폼인 Activity, service를 사용하는 모든 클래스들을 의미한다.
- 엔트리포인트를 시작으로 R8 런타임에서 앱이 사용하는 모든 메소드, 멤버 변수를 찾아 그래프를 그린다.
- 그래프에 포함되지 않은 코드들은 삭제된다.
- 다음 그림에서 MainActivity 엔트리 포인트에서 접근하는 foo(), faz(), bar(), AwsomeApi.class가 그래프에 그려졌고 OkayApi.class와 해당 메서드가 그래프에 포함되지 않아 삭제된다.

<img src="https://developer.android.com/studio/images/build/r8/tree-shaking.png"/>

- R8은 프로젝트의 R8 configuration file의 `-keep`규칙을 이용하여 엔트리 포인트를 결정한다.
- AGP, AAPT2가 자동적으로 앱의 activity, view, service에 대한 keep 규칙을 자동적으로 생성해준다.
- 이러한 규칙을 커스텀하게 사용하면 이용하면 접근하지 않은 OkayApi.class를 엔트리 포인트르 취급할 수 있게 해준다.

### Customize code keep

- 대부분의 상황에서는 기본 설정(*proguard-android- optimize.txt*)만 있다면 사용하지 않는 코드를 제거하는데에는 문제가 없을 수 있다.
- 하지만, 특정 상황에서는 R8이 명확하게 분석하기 어려워 실제로 필요한 코드를 삭제할 수 있다.
- 다음같은 상황에서는 필요한 코드가 의도치 않게 코드가 삭제될 수 있다.
  - 앱이 JNI 메서드를 호출할 경우
  - 런타임에 리플렉션으로 코드를 찾을 경우
- 테스트를 하다보면 에러가 발생하지만 buildType이 release인 경우에 코드 축소를 하다보면 이런 상황을 빠르게 접하지 못 할 수 있다. (삭제된 코드들은 따로 [보고서 형태로도 받아 볼 수 있다](#삭제된-코드-보고서로-받아보기))
- proguardFile에 `-keep`을 추가하여 R8에서 삭제할 수 없도록 한다.

```
-keep public class MyClass
```

- 혹은 삭제하지 않고 유지하고 싶은 코드에 `@keep`을 추가할 수도 있다.
- 메서드나 필드에 추가함으로서 해당 클래스 또한 삭제되지 않는다.
- 다만 `@keep` 어노테이션은 AndroidX Annotations Liabary에 포함되어 있고 AGP로 패키징된 proguard rules 파일이 있을 경우에 동작한다.

> https://android.googlesource.com/platform/sdk/+/master/files/proguard-android.txt
> https://android.googlesource.com/platform/sdk/+/master/files/proguard-android-optimize.txt

### 삭제된 코드 보고서로 받아보기

- 일반적으로 삭제된 코드들은 `build/outputs/mapping/{buildVarient}/usage.txt` 에 작성된다.
- 다음을 proguard rule에 넣으면 원하는 곳에 보고서를 생성해준다.
  - `-printusage <output-dir>/usage.txt`
- 실제로 사용되지 않는 몇몇 변수와 메서드를 작성하면 `usage.txt`에 나타나게 된다.


<img width="300" alt="스크린샷 2022-04-16 오후 5 25 47" src="https://user-images.githubusercontent.com/58923717/163668083-eda61077-2ca0-4872-a6d2-0121bec188d9.png" />
<div>
<img width="370" alt="스크린샷 2022-04-16 오후 5 27 37" src="https://user-images.githubusercontent.com/58923717/163668119-4bd80c61-26de-4e2a-b8d7-a0972c6f3f13.png" />
<img width="370" alt="스크린샷 2022-04-16 오후 5 29 46" src="https://user-images.githubusercontent.com/58923717/163668183-df951d14-77bb-41e1-98dd-c5bbb4c41e87.png" />
</div>


### usage (작성 중...)

```groovy
android {
    buildTypes {
        release {
            // 릴리즈 빌드 타입에 코드 축소, 난독화, 최적화를 진행하도록 한다.
            minifyEnabled true
        }
    }
}
```



## Resource shrinking (리소스 축소)

## Obfuscation (난독화)

## Optimization (최적화)